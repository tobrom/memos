---
title: "Amazon Web Services, R and Shiny"
author: "Tobias Romar"
date: "4 augusti 2017"
output: html_document
---

## Introduction

The purpose with this document is to go through the necessary steps in order to 
run shiny applications on an AWS instance. Further, it will go through the steps 
in order to install R Studio Server and transfer files between a local machine 
and the instance on AWS. In addition it will go through the most important 
commands that will be used in the Ubuntu CLI in relation to R and Shiny. 

The guide will be based on the components included in the 12-month free period 
offered by Amazon. The steps are based on the asssumption that the connection is 
made from a local Windows machine.  

The information here is based on different sources online combined with 
own experice and findings.

#### Content

1. Create an AWS Account
2. Create an AWS EC2 Ubuntu Instance
3. Download and Install PuTTY
4. Convert Keys Using PuTTYgen
5. Connect to the Ubuntu Instance with PuTTY
6. Upgrade the Ubuntu Instance
7. Install R
8. Install the Shiny Package
9. Install Shiny Server
10. Configure the Firewall
11. Deploy the Example App
12. Transferring Files Using WinSCP
13. Deploy Own Shiny App
14. Install R Studio Server
15. Log-in to R Studio Server through browser


## 1. Create an AWS account

The very first step is to sign up on AWS and create an account: 
<https://aws.amazon.com/>

## 2. Create an AWS EC2 Ubuntu Instance

When you have signed up for an AWS account, the next step is to create an 
instance. This is basically the machine that will be running in the cloud and 
there are a wide range of possibilities when it comes to the type of instance, 
AMI (software configuration) and storage that you can choose between. Since 
R Studio Server and Shiny Server does not support Windows, the latest Ubuntu 
Server is a good choice for this purpose. The AWS free tier which gives the 
user a 12-month free period can be used in this case.  

**Ubuntu** is a Debian-based Linux operating system.

During the process of setting up the instance, the wizard will ask you about 
the key pair. The key pair is needed in order to connect to the AWS instance 
through SSH. Store the keys on your local computer, you will need them later.

**Secure Shell (SSH)** is a cryptographic network protocol for operating network 
services securely over an unsecured network.The best known example application 
is for remote login to computer systems by users. 

After going through the wizard and creating the keys the final step is to click 
"Launch Instances" which means that the instance has been created.

## 3. Download and Install PuTTY

In order to connect from a local Windows machine you need to install PuTTY which 
you can download from here: <http://www.putty.org/>

**PuTTY:** is an SSH and telnet client, developed originally by Simon Tatham for 
the Windows platform. PuTTY is open source software that is available with 
source code and is developed and supported by a group of volunteers.

## 4. Convert Keys Using PuTTYgen

PuTTY does not natively support the private key format (.pem) generated by 
Amazon EC2. PuTTY has a tool named PuTTYgen, which can convert keys to the 
required PuTTY format (.ppk). You must convert your private key into this format 
(.ppk) before attempting to connect to your instance using PuTTY.

Detailed instructions provided by AWS: 
<http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/putty.html>
 
## 5. Connect to the Ubuntu Instance with PuTTY

In order to connect to your Ubuntu instance you need:

1. The .ppk file that you created for your private key
2. User Name (for Ubuntu you can use: ubuntu) 
3. Public DNS Name (you find it in the Amazon EC2 console)
 
Start PuTTY and fill in the following in the first window:

- Host Name: ubuntu@(Public DNS Name)
- Port: 22
- Connection type: SSH

Browse for the converted keys (.ppk) in the Connection-SSH-Auth category.

Finally enable inbound SSH traffic from your IP address to your instance. Ensure 
that the security group associated with your instance allows incoming SSH 
traffic from your IP address.

- Type: SSH
- Source: My IP


Now you should be connected to your Ubuntu instance through PuTTY.

detailed instructions provided by AWS: 
<http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/putty.html>

## 6. Upgrade the Ubuntu Instance

Start by upgrading to the latest versions of Ubuntu. Typing the command below 
will install the newest versions of all packages currently installed on the 
system from the sources enumerated in /etc/apt/sources.list. In addition 
changing dependencies with new versions of packages; apt-get has a "smart" 
conflict resolution system, and it will attempt to upgrade the most 
important packages at the expense of less important ones if necessary.

```{r eval = FALSE}
sudo apt-get dist-upgrade
```

When prompted, type Y and install the package maintainer’s version. 
 
## 7. Install R

To make sure that we get the latest R packages, we first need to add a CRAN 
mirror to the "sources.list" file. Finally we also need to install r-base. 

More info here: <https://cran.r-project.org/bin/linux/ubuntu/README> 
 
Start by typing the following:
```{r eval = FALSE}
sudo apt-get upgrade
```
 
Then you need to open the "sources.list" by typing: 
```{r eval = FALSE}
sudo nano /etc/apt/sources.list
```
 
Add the following (change xenial if you use another version) to the end of 
the "sources.list" and save and close: 
```{r eval = FALSE}
deb http://cran.rstudio.com/bin/linux/ubuntu xenial/
```

The Ubuntu archives on CRAN are signed with the key of “Michael Rutter 
marutter@gmail.com” with key ID E084DAB9. To add the key to your system with 
one command type:  
```{r eval = FALSE}
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
```

Finally, install R by typing:
```{r eval = FALSE}
sudo apt-get update
sudo apt-get install r-base 
```

Now you can start R by typing...
```{r eval = FALSE}
sudo -I R
```
 
...and end the session by typing:
```{r eval = FALSE}
quit()
```

## 8. Install Shiny 
 
Install Shiny by typing the following: 
```{r eval = FALSE}
sudo su - -c "R -e \"install.packages('shiny', repos='https://cran.rstudio.com/')\""
``` 
 
## 9. Install Shiny Server

Start by checking the most recent version here: 
<https://www.rstudio.com/products/shiny/download-server/> 

Then type the following rows (but change to the latest version):
```{r eval = FALSE}
sudo apt-get install gdebi-core
wget https://download3.rstudio.org/ubuntu-12.04/x86_64/shiny-server-1.5.3.838-amd64.deb
sudo gdebi shiny-server-1.5.3.838-amd64.deb
```

## 10. Configure the Firewall 

In order to connect to Shiny Server and access your apps, you need to open the 
port on which Shiny Server listens. By default, this is port 3838. Go to the 
Security Groups configuration screen, click on the Inbound tab and add a 
new rule:

- Type: Custom TCP Rule
- Protocol: TCP
- Port Range: 3839
- Source: My IP (change later to open up for other)

## 11. Deploy the Example App 
 
There is a sample app that is provided by the Shiny installer, type the 
following to deploy it: 
```{r eval = FALSE}
sudo /opt/shiny-server/bin/deploy-example default
``` 
 
Now you should be able to access the app, go to the browser and type: 
http://publicIPaddress:3838/sample-apps/hello/ where **publicIPaddress** is the 
public IP address of the instance.


In order to stop, start and restart the shiny server you can type the 
following:

```{r eval = FALSE}
sudo systemctl stop shiny-server
sudo systemctl start shiny-server
sudo systemctl restart shiny-server
``` 

## 12. Transferring Files Using WinSCP

Download and install WinSCP. Download file found here: 
<https://winscp.net/eng/download.php>

- Host name: Public IPv4 address for the instance
- User name: ubuntu
- Specify the private key for your instance. 
WinSCP requires a PuTTY private key file (.ppk)

More detailed information from AWS: 
<http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/putty.html>

## 13. Deploy Own Shiny App 
 
Three different ways to deploy an app:

1. From computer
  + Upload app folder (containing .R scripts) through R Studio Server
  + Deploy:

```{r eval = FALSE}
cd /
sudo mv /app_folder /srv/shiny-server/
``` 

2. From Rstudio
 + Install git through Ubuntu console
 + Connect to Rstudio server and clone project directly from Github
  
```{r eval = FALSE}
sudo apt-get install git-core
...
cd /
sudo mv /app_folder /srv/shiny-server/
```  
 
3. Directly from github through R console
 + Install devtools
```{r eval = FALSE}
sudo apt-get install build-essential libcurl4-gnutls-dev libxml2-dev libssl-dev
sudo -i R
install.packages('devtools')
devtools::install_github('rstudio/shiny')
``` 
 + Run R and install directly from Github

```{r eval = FALSE}
sudo -i R

git2r::clone("https://github.com/rstudio/shiny-examples.git", "/srv/shiny-server/Rmethod")
```  

**Note:** Before an app can be deployed all the required packages needs to be 
installed on the instance:

```{r eval = FALSE}
sudo -i R
install.packages(c("tm","memoise","wordcloud"))
``` 
 
## 14. Install R Studio Server

To download and install RStudio Server open a terminal window and execute 
the following commands: 

```{r eval = FALSE}
sudo apt-get install gdebi-core
wget https://download2.rstudio.org/rstudio-server-1.0.153-amd64.deb
sudo gdebi rstudio-server-1.0.153-amd64.deb
``` 

Information about a potential newer version: 
<https://www.rstudio.com/products/rstudio/download-server/>

## 15. Login to R Studio Server through browser

RStudio Server runs on port 8787 so in order to acccess you need
to open up that port for inbound traffic for the EC2 instance.

After that you should be able to access R Studio Server by typing
the following into the brows
```{r eval = FALSE}
http://<server-ip>:8787
``` 

When you login to RStudio it willl prompt for a username and password, and will authenticate 
the user by checking the server's username and password database.

If you have not created a username and password you can do that by typing
the following in the Ubuntu CLI (in the process you are prompted to select a 
password):

```{r eval = FALSE}
sudo adduser
``` 
 
 
